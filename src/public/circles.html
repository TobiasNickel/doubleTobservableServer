<!DOCTYPE html>
<html>
<head>
	<title>
		doubleTobservable Circles
	</title>
	<link rel='stylesheet' href='/stylesheets/style.css' />
    <style>
        #viewPort{
            position:absolute;left:0px;top:0px;width:100%;height:100%;z-index:-1;}
        #viewPort .tobserverlistitem{
            position:absolute;left:0px;top:0px;width:0px;height:0px;}
        .circle{
            border-radius:10000000px;
            position:relative;
            background-color:blue; 
        }
        .circle:hover{
            box-shadow:2px 2px 0px black,2px -2px 0px black,-2px -2px 0px black,-2px 2px 0px black;
        }
        #circleControlls{
            width:300px;
            float:left;
        }
        
        #circleControlls .tobserverlistitem{
            border:1px black solid;
            
        }
    </style>
	<script src="/javascripts/jquery.js"></script>
	<script src="/javascripts/tobserver.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
        // init Socket
  		var socket = io('/tobserver');
		tobserver.utils.setSocket(socket);
			
        //init data
		var app={};
            // under /data.json, and with param p you can query current data from a path
        $.get("/data.json",{p:"app.circles"},function(res){
            if(res.status)
                tobserver.set("app.circles",res.data);
            else
                tobserver.set("app.circles",[]);
        });
        
        // some default data
        // can be loaded on the console with: tobserver.set('app.circles',tobiCircles);
		var tobiCircles=[{"radius":816,"x":-103,"y":297,"red":255,"green":0,"blue":255},{"radius":699,"x":-90,"y":322,"red":255,"green":255,"blue":0},{"radius":53,"x":85,"y":327,"red":0,"green":0,"blue":0},{"radius":50,"x":328.5,"y":574.5,"red":0,"green":0,"blue":0},{"radius":50,"x":346.5,"y":612.5,"red":0,"green":0,"blue":0},{"radius":50,"x":330.5,"y":650.5,"red":0,"green":0,"blue":0},{"radius":50,"x":299.5,"y":667.5,"red":0,"green":0,"blue":0},{"radius":50,"x":285.5,"y":567.5,"red":0,"green":0,"blue":0},{"radius":50,"x":256.5,"y":659.5,"red":0,"green":0,"blue":0},{"radius":50,"x":232.5,"y":623.5,"red":0,"green":0,"blue":0},{"radius":50,"x":245.5,"y":583.5,"red":0,"green":0,"blue":0},{"radius":50,"x":354.5,"y":731.5,"red":0,"green":0,"blue":0},{"radius":50,"x":331.5,"y":733.5,"red":0,"green":0,"blue":0},{"radius":50,"x":305.5,"y":733.5,"red":0,"green":0,"blue":0},{"radius":50,"x":275.5,"y":731.5,"red":0,"green":0,"blue":0},{"radius":50,"x":247.5,"y":730.5,"red":0,"green":0,"blue":0},{"radius":50,"x":219.5,"y":730.5,"red":0,"green":0,"blue":0},{"radius":50,"x":355.5,"y":769.5,"red":0,"green":0,"blue":0},{"radius":50,"x":337.5,"y":798.5,"red":0,"green":0,"blue":0},{"radius":50,"x":292.5,"y":789.5,"red":0,"green":0,"blue":0},{"radius":50,"x":151.5,"y":881.5,"red":255,"green":0,"blue":255},{"radius":50,"x":307.5,"y":804.5,"red":0,"green":0,"blue":0},{"radius":50,"x":189.5,"y":730.5,"red":0,"green":0,"blue":0},{"radius":50,"x":358.5,"y":879.5,"red":0,"green":0,"blue":0},{"radius":50,"x":248.5,"y":878.5,"red":0,"green":0,"blue":0},{"radius":50,"x":285.5,"y":879.5,"red":0,"green":0,"blue":0},{"radius":50,"x":323.5,"y":878.5,"red":0,"green":0,"blue":0},{"radius":50,"x":89.5,"y":623.5,"red":0,"green":0,"blue":0},{"radius":50,"x":209.5,"y":879.5,"red":0,"green":0,"blue":0},{"radius":50,"x":89.5,"y":542.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":584.5,"red":0,"green":0,"blue":0},{"radius":50,"x":87.5,"y":366.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":699.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":662.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":845.5,"red":0,"green":0,"blue":0},{"radius":50,"x":92.5,"y":810.5,"red":0,"green":0,"blue":0},{"radius":50,"x":91.5,"y":736.5,"red":0,"green":0,"blue":0},{"radius":50,"x":91.5,"y":771.5,"red":0,"green":0,"blue":0},{"radius":81,"x":274.5,"y":601.5,"red":255,"green":255,"blue":0},{"radius":50,"x":90.5,"y":882.5,"red":0,"green":0,"blue":0},{"radius":50,"x":91.5,"y":916.5,"red":0,"green":0,"blue":0},{"radius":50,"x":280.5,"y":758.5,"red":0,"green":0,"blue":0},{"radius":50,"x":159.5,"y":729.5,"red":0,"green":0,"blue":0},{"radius":50,"x":87,"y":348.5,"red":0,"green":0,"blue":0},{"radius":50,"x":317.5,"y":765.5,"red":255,"green":0,"blue":0},{"radius":50,"x":90.5,"y":962.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":940.5,"red":0,"green":0,"blue":0},{"radius":50,"x":89.5,"y":550.5,"red":0,"green":0,"blue":0},{"radius":50,"x":93.5,"y":518.5,"red":0,"green":0,"blue":0},{"radius":50,"x":91.5,"y":563.5,"red":0,"green":0,"blue":0},{"radius":50,"x":89.5,"y":603.5,"red":0,"green":0,"blue":0},{"radius":50,"x":88.5,"y":643.5,"red":0,"green":0,"blue":0},{"radius":50,"x":89.5,"y":681.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":719.5,"red":0,"green":0,"blue":0},{"radius":50,"x":91.5,"y":753.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":792.5,"red":0,"green":0,"blue":0},{"radius":50,"x":92.5,"y":827.5,"red":0,"green":0,"blue":0},{"radius":50,"x":88.5,"y":861.5,"red":0,"green":0,"blue":0},{"radius":50,"x":90.5,"y":898.5,"red":0,"green":0,"blue":0},{"radius":104,"x":278,"y":405,"red":0,"green":0,"blue":0},{"radius":104,"x":146,"y":410,"red":0,"green":0,"blue":0},{"radius":104,"x":206,"y":406,"red":0,"green":0,"blue":0},{"radius":104,"x":306.5,"y":404.5,"red":0,"green":0,"blue":0},{"radius":100,"x":278.5,"y":407.5,"red":255,"green":255,"blue":255},{"radius":104,"x":241.5,"y":405.5,"red":0,"green":0,"blue":0},{"radius":100,"x":206,"y":408,"red":255,"green":255,"blue":255},{"radius":104,"x":181.5,"y":409.5,"red":0,"green":0,"blue":0},{"radius":100,"x":149,"y":412,"red":255,"green":255,"blue":255},{"radius":100,"x":120,"y":413,"red":0,"green":0,"blue":0},{"radius":104,"x":93,"y":413,"red":0,"green":0,"blue":0},{"radius":100,"x":94,"y":415,"red":255,"green":255,"blue":255},{"radius":50,"x":91.5,"y":452.5,"red":0,"green":0,"blue":0},{"radius":50,"x":88.5,"y":405.5,"red":0,"green":0,"blue":0},{"radius":50,"x":91.5,"y":430.5,"red":0,"green":0,"blue":0},{"radius":50,"x":94.5,"y":474.5,"red":0,"green":0,"blue":0},{"radius":50,"x":94.5,"y":498.5,"red":0,"green":0,"blue":0},{"radius":50,"x":88.5,"y":387.5,"red":0,"green":0,"blue":0}];
        
		app.selectedCircle=null;
		tobserver.notifyee.locals.push("app.selectedCircle");
        tobserver.utils.linkToArrayViews("app.selectedCircle","app.circles");
        tobserver.notifyee.onlineLiveMode=true ;
        
        // Logic BEGIN
        /**
         * creates a new circle in the middle of the screen
         */
		function newCircle(){
			tobserver.exec("app.circles.push",[{radius:50,x:window.innerHeight/2,y:window.innerWidth/2,red:0,green:0,blue:0}]);
		};
        /**
         * std helper, to set the pixel value of the circle,
         * as you can see, the radius will be the with directly.
         */
        function addPX(a){return a+"px";}
        
        // MOVING LOGIC WITH DRAG AND DROP :: BEGIN
        var moveCircle=null;
        var lastX=0; 
        var lastY=0;
        $(document).on("mousemove",function(ev){
            if(moveCircle){
                //console.log(lastX,lastY);
                var index=app.circles.indexOf(moveCircle);

                tobserver.set("app.circles."+index+".x",moveCircle.x-(lastY-ev.screenY));
                tobserver.set("app.circles."+index+".y",moveCircle.y-(lastX-ev.screenX));
            }
       
            lastX=ev.screenX;
            lastY=ev.screenY;
        });
        function circleMoveEventAdding(listElement){
            //console.log("addedElement")
            var circleElemement=listElement.children[0];
            
            var $circleElemement=jQuery(circleElemement);
             $circleElemement.on("mousedown",function(ev){
                moveCircle=circleElemement.data;
                tobserver.set("app.selectedCircle", circleElemement.data);
            });
            $circleElemement.on("mouseup",function(ev){
                moveCircle=null;
            });
            
        }
        // MOVING LOGIC WITH DRAG AND DROP :: END
        /**
         * creating colorString from a circle
         */
        function circlesColorCode(c){
            if(!c || !c.red==null)return "#000000";
            var r=c.red.toString(16);
            var g=c.green.toString(16);
            var b=c.blue.toString(16);
            r=r.length<2?"0"+r:r;
            g=g.length<2?"0"+g:g;
            b=b.length<2?"0"+b:b;
            return '#'+r+g+b;
        }
        //two methods to bring a Circle to the top or to the bottom.
        function moveUp(c){
            var i = app.circles.indexOf(c);
            if(i !== -1)
                tobserver.exec("app.circles.splice",[i,1]);
            tobserver.exec("app.circles.push",[c]);
        }
        function moveDown(c){
            var i = app.circles.indexOf(c);
            if(i !== -1)
                tobserver.exec("app.circles.splice",[i,1]);
            tobserver.exec("app.circles.unshift",[c]);
        }
        // Logic END
	</script>
</head>
<body>
	<h1>doubleTobservable Circles</h1>
	<button onclick="newCircle()">neuer Creis</button>
	<div tobserver="path:'app.selectedCircle', type:'htmloption', filter:function(c){ return c!==null; } ">
        <ul id="circleControlls">
            <li>Radius: <input tobserver="path:'app.selectedCircle.radius',type:'value'," value="0" type="number" /></li>
            <li>x: <input tobserver="path:'app.selectedCircle.x',type:'value'" value="0" type="number" /></li>
            <li>y: <input tobserver="path:'app.selectedCircle.y',type:'value'" value="0" type="number" /></li>
            <li>red: <input tobserver="path:'app.selectedCircle.red',type:'value'" value="0" type="range" min="0" max="255" step="1"/></li>
            <li>green: <input tobserver="path:'app.selectedCircle.green',type:'value'" value="0" type="range" min="0" max="255" step="1" /></li>
            <li>blue: <input tobserver="path:'app.selectedCircle.blue',type:'value'" value="0" type="range" min="0" max="255" step="1" /></li>
            <li>
                <button tobserver="path:'app.selectedCircle',type:'data'" onclick="moveUp(this.data)">UP</button>
                <button tobserver="path:'app.selectedCircle',type:'data'" onclick="moveDown(this.data)">DPWN</button>
            </li>
        </ul>
    </div>
    <div id="viewPort"  tobserver="path:'app.circles',type:'htmllist',beforeAdd:circleMoveEventAdding">
        <div class="circle" tobserver="
            path:['radius','radius','x','y','','','',''],
            type:['width','height','top','left','backgroundColor','backgroundColor','backgroundColor','data'],
            filter:[addPX,addPX,addPX,addPX,circlesColorCode,circlesColorCode,circlesColorCode]
        "></div>
    </div>
</body>

</html>
